<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Doctor Dashboard — Statistics</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#f8fafc; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .card { border:0; border-radius:12px; box-shadow: 0 6px 20px rgba(15,23,42,0.06); }
    .page-header { display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:1.25rem; }
    .small-muted { color:#6b7280; font-size:0.9rem; }
    .stat-number { font-weight:700; font-size:2rem; color:#0f172a; }
    .legend-pill { display:inline-block; padding:6px 10px; border-radius:999px; color:#fff; font-size:0.85rem; margin-right:6px; }

    /* Center charts and constrain width */
    .chart-center { display:flex; justify-content:center; align-items:center; }
    .chart-box { width:100%; max-width:820px; height:360px; }
    .chart-small { height:300px; max-width:420px; }

    /* responsive tweaks */
    @media (max-width: 992px) {
      .chart-box { height:300px; }
      .chart-small { height:260px; }
    }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <div class="page-header">
      <div>
        <h3 class="mb-0">Doctor — Statistics Dashboard</h3>
        <div class="small-muted">Overview of current patient distribution and treatment patterns</div>
      </div>
      <div class="d-flex align-items-center">
        <a class="btn btn-outline-secondary me-2" href="{{ url_for('doctor_dashboard') }}">Back to Dashboard</a>
        <a class="btn btn-primary" href="{{ url_for('doctor_stats') }}">Refresh</a>
      </div>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-lg-4">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="mb-1 text-muted">Total patients</h6>
              <div class="stat-number">{{ total_patients }}</div>
            </div>
            <div class="text-end small-muted">
              <div>Gender split</div>
              <div class="mt-2">
                {% for g, c in genders.items() %}
                  <div><strong>{{ g|capitalize }}</strong>: {{ c }}</div>
                {% endfor %}
              </div>
            </div>
          </div>

          <!-- centered donut -->
          <div class="chart-center mt-3">
            <div class="chart-box chart-small">
              <canvas id="donutChart"></canvas>
            </div>
          </div>

        </div>
      </div>

      <div class="col-lg-8">
        <div class="card p-3">
          <h6 class="mb-2">Pattern × Severity (4 categories)</h6>
          <div class="small-muted mb-2">Intermittent / Persistent × Mild / Moderate–Severe</div>

          <!-- centered combo -->
          <div class="chart-center">
            <div class="chart-box">
              <canvas id="comboChart"></canvas>
            </div>
          </div>

          <div class="mt-2 small-muted">Categories: Intermit+mild, Intermit+mod–sev, Persist+mild, Persist+mod–sev</div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card p-3">
          <h6 class="mb-2">Treatment counts</h6>
          <div class="chart-center">
            <div class="chart-box">
              <canvas id="treatmentChart"></canvas>
            </div>
          </div>
          <div class="mt-2">
            <div class="small-muted">Treatments detected from recommendations</div>
            <div class="mt-2" id="treatment-pills" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;"></div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card p-3">
          <h6 class="mb-2">VAS distribution (0–10)</h6>
          <div class="small-muted mb-2">Number of patients by reported average VAS score</div>

          <!-- centered vas -->
          <div class="chart-center">
            <div class="chart-box">
              <canvas id="vasChart"></canvas>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

<script>
const genders = {{ genders | tojson }};
const comboCounts = {{ combo_counts | tojson }};
const treatments = {{ treatments | tojson }};
const vasCounts = {{ vas_counts | tojson }};

// color palette
const palette = ['#0d6efd','#198754','#0ea5a4','#f59e0b','#7c3aed','#ef4444','#6b7280'];

// Donut chart
const donutCtx = document.getElementById('donutChart').getContext('2d');
new Chart(donutCtx, {
  type: 'doughnut',
  data: {
    labels: Object.keys(genders).map(k => k.charAt(0).toUpperCase()+k.slice(1)),
    datasets: [{ data: Object.values(genders), backgroundColor: palette.slice(0, Object.keys(genders).length) }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'bottom' },
      tooltip: { enabled: true }
    }
  }
});

// Combo bar (4 bars)
const comboCtx = document.getElementById('comboChart').getContext('2d');
new Chart(comboCtx, {
  type: 'bar',
  data: {
    labels: ['Intermit + mild','Intermit + mod–sev','Persist + mild','Persist + mod–sev'],
    datasets: [{
      label: 'Patients',
      data: comboCounts,
      backgroundColor: ['#4f46e5','#7c3aed','#0ea5a4','#f59e0b'],
      borderRadius: 6,
      barPercentage: 0.6
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: { beginAtZero: true, ticks: { precision:0, stepSize: 1 } }
    },
    plugins: {
      legend: { display: false },
      tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}` } }
    }
  }
});

// Treatment counts (horizontal)
const trLabelsRaw = Object.keys(treatments);
const trLabels = trLabelsRaw.map(l => l.replace(/_/g,' ').replace(/\b\w/g, s => s.toUpperCase()));
const trValues = Object.values(treatments);
const trColors = palette.slice(0, trLabels.length);

const trCtx = document.getElementById('treatmentChart').getContext('2d');
new Chart(trCtx, {
  type: 'bar',
  data: {
    labels: trLabels,
    datasets: [{ label: 'Count', data: trValues, backgroundColor: trColors, borderRadius: 6 }]
  },
  options: {
    indexAxis: 'y',
    responsive: true,
    maintainAspectRatio: false,
    scales: { x: { beginAtZero:true, ticks: { precision:0, stepSize: 1 } } },
    plugins: { legend: { display:false }, tooltip: { callbacks: { label: ctx => `Count: ${ctx.parsed.x}` } } }
  }
});

// Populate treatment pills
const pillsContainer = document.getElementById('treatment-pills');
trLabelsRaw.forEach((key, idx) => {
  const label = trLabels[idx];
  const count = trValues[idx];
  const color = trColors[idx];
  const pill = document.createElement('span');
  pill.className = 'legend-pill';
  pill.style.background = color;
  pill.textContent = `${label}: ${count}`;
  pill.style.marginRight = '8px';
  pillsContainer.appendChild(pill);
});

// VAS distribution
const vasCtx = document.getElementById('vasChart').getContext('2d');
new Chart(vasCtx, {
  type: 'bar',
  data: {
    labels: Array.from({length:11}, (_,i)=>String(i)),
    datasets: [{ label: 'Patients', data: vasCounts, backgroundColor: '#0d9488', borderRadius: 6 }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: { y: { beginAtZero:true, ticks: { precision:0, stepSize: 1 } } },
    plugins: { legend: { display:false }, tooltip: { callbacks: { label: ctx => `Patients: ${ctx.parsed.y}` } } }
  }
});
</script>

</body>
</html>